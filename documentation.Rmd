```{r Preparation of the environment, message=FALSE, warning=FALSE}
cat("\014")
rm(list = ls())
library(dplyr)
library(ggplot2)
library(kohonen)
```

```{r Loading the data and their preprocessing}

dataset <- read.csv("dataset.txt", 
                        header = TRUE, 
                        sep = ",",
                        stringsAsFactors = FALSE)

for (i in 1:5){
  dataset[,i] <- as.numeric(dataset[,i])
}

Malignant <- dataset[dataset$Severity == 1,]
Benign <- dataset[dataset$Severity == 0,]

for (i in 1:5){
  Malignant[is.na(Malignant[,i]),i] <- median(Malignant[,i], na.rm = T)
  Benign[is.na(Benign[,i]),i] <- median(Benign[,i], na.rm = T)
}

Benign <- Benign[!(Benign$BI.RADS < 1 | Benign$BI.RADS > 5  | Benign$Shape < 1  | Benign$Shape > 4
                  | Benign$Margin < 1  | Benign$Margin > 5  | Benign$Density < 1  | Benign$Density > 4),]
Malignant <- Malignant[!(Malignant$BI.RADS < 1 | Malignant$BI.RADS > 5  | Malignant$Shape < 1  | Malignant$Shape > 4
                  | Malignant$Margin < 1  | Malignant$Margin > 5  | Malignant$Density < 1  | Malignant$Density > 4),]

numberOfMalignant <- nrow(Malignant)
numberOfBenign <- nrow(Benign)

dataset <- rbind(Malignant,Benign)
traingingData <- rbind(Malignant[1:round(dim(Malignant)[1]/2),],Benign[1:round(dim(Benign)[1]/2),])
testingData <- rbind(Malignant[(round(dim(Malignant)[1]/2)+1):dim(Malignant)[1],],Benign[(round(dim(Benign)[1]/2)+1):dim(Benign)[1],])

```

```{r Histograms}

ggplot(Malignant,aes(BI.RADS)) + geom_histogram(bins = 4, alpha = 0.5, fill = 'red') + 
  geom_histogram(data = Benign,mapping = aes(BI.RADS),bins = 4, alpha = 0.5, fill = 'blue') +
  ggtitle("Histogram of BI.RADS values") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(name="BI.RADS values",values=c("blue","red"),labels=c("Malignant","Benign"))

ggplot(Malignant,aes(Age)) + geom_histogram(bins = 4, alpha = 0.5, fill = 'red') + 
  geom_histogram(data = Benign,mapping = aes(Age),bins = 4, alpha = 0.5, fill = 'blue') +
  ggtitle("Histogram of Age values") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(name="Age values",values=c("blue","red"),labels=c("Malignant","Benign"))

ggplot(Malignant,aes(Shape)) + geom_histogram(bins = 4, alpha = 0.5, fill = 'red') + 
  geom_histogram(data = Benign,mapping = aes(Shape),bins = 4, alpha = 0.5, fill = 'blue') +
  ggtitle("Histogram of Shape values") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(name="Shape values",values=c("blue","red"),labels=c("Malignant","Benign"))

ggplot(Malignant,aes(Margin)) + geom_histogram(bins = 4, alpha = 0.5, fill = 'red') + 
  geom_histogram(data = Benign,mapping = aes(Margin),bins = 4, alpha = 0.5, fill = 'blue') +
  ggtitle("Histogram of Margin values") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(name="Margin values",values=c("blue","red"),labels=c("Malignant","Benign"))

ggplot(Malignant,aes(Density)) + geom_histogram(bins = 4, alpha = 0.5, fill = 'red') + 
  geom_histogram(data = Benign,mapping = aes(Density),bins = 4, alpha = 0.5, fill = 'blue') +
  ggtitle("Histogram of Density values") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(name="Density values",values=c("blue","red"),labels=c("Malignant","Benign"))

ggplot(Malignant,aes(Severity)) + geom_histogram(bins = 2, alpha = 0.5, fill = 'red') + 
  geom_histogram(data = Benign,mapping = aes(Severity),bins = 2, alpha = 0.5, fill = 'blue') +
  ggtitle("Histogram of Severity values") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_manual(name="Severity values",values=c("blue","red"),labels=c("Malignant","Benign"))

```

```{r Data normalization}
for (i in 1:5){
  traingingData[,i] <- (traingingData[,i] - min(traingingData[,i]))/(max(traingingData[,i])-min(traingingData[,i]))
  testingData[,i] <- (testingData[,i] - min(testingData[,i]))/(max(testingData[,i])-min(testingData[,i]))
}
```

```{r Parameter setting for SOM}

gridNumOfRow = 20
gridNumOfCol = 20
numberOfIterations = 10000
learningRate = c(0.05,0.001)
topology = c("rectangular", "hexagonal")
data_train_matrix <- as.matrix(traingingData[,1:5])
som_grid <- somgrid(xdim = gridNumOfRow, ydim=gridNumOfCol, topo=topology[2], neighbourhood.fct = "gaussian")
som_model <- som(data_train_matrix, 
		grid=som_grid, 
		rlen=numberOfIterations, 
		alpha=learningRate, 
		keep.data = TRUE)

```

```{r SOM Charts}
## Training Progress:
plot(som_model, type="changes")

## Node Counts
plot(som_model, type="count")

## Node Maps
plot(som_model, type="mapping")

## Node quality
plot(som_model, type="quality")

## Neighbour Distance
plot(som_model, type="dist.neighbours")
plot(som_model, type="codes")

c <- som_model$codes 
## use hierarchical clustering to cluster the codebook vectors
som_cluster <- cutree(hclust(dist(som_model$codes[[1]])), 2)
# plot these results:
plot(som_model, type="mapping", bgcol = pretty_palette[som_cluster], main = "Clusters") 
add.cluster.boundaries(som_model, som_cluster)

```

```{r SOM network test - on unknown data (error after learning)}

pred <- predict(som_model, newdata = as.matrix(testingData[,1:5]), trainingdata = as.matrix(traingingData[,1:5]))
# table(Predicted = pred$predictions[[1]], Actual = as.matrix(testingData[,1:5]))
# pred$predictions[[1]]
# som_cluster_test <- cutree(hclust(dist(pred$predictions[[1]])), som_cluster)
# plot(som_model, type="mapping", bgcol = pretty_palette[s

# new_data_units <- map(som_model, newdata = data.matrix(testingData[,1:5]))
# 
# ## get the classification for closest map units
# 
# new_data_classes <- som_cluster[new_data_units$unit.classif]


```

```{r Test results for SOM + SOM operating and network sensitivity}

```
